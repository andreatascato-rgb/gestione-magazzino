1. Import da aggiungere in alto

import { execSync } from 'child_process';
import fs from 'fs';
(se nel file sono gi√† presenti queste import, saltale)

2. Costanti da mettere dopo gli import

const PROTOCOL_STATUS_FILE = '.protocol-status.json';
const LSP_CHECK_REQUIRED_FILE = '.lsp-check-required';

3. Funzione checkLSPErrors

function checkLSPErrors(): boolean {
  try {
    console.log('üîç PROTOCOLLO ANTI-REGRESSIONE: Controllo errori LSP/TypeScript...');

    execSync('npx tsc --noEmit --skipLibCheck', { stdio: 'inherit' });

    console.log('‚úÖ Nessun errore LSP rilevato - Sistema sicuro per l\'avvio');
    return true;
  } catch (error: any) {
    console.error('\nüõë ===== PROTOCOLLO ANTI-REGRESSIONE ULTRA-RIGIDO ATTIVATO =====');
    console.error('‚ùå ERRORI LSP/TYPESCRIPT RILEVATI - AVVIO BLOCCATO\n');
    console.error('üìã DETTAGLI ERRORI:');
    console.error(error.stdout?.toString() || error.message);
    console.error('\nüö® Il server NON pu√≤ avviarsi con errori LSP presenti');
    console.error('================================================\n');
    return false;
  }
}

4. Funzione isLSPCheckRequired

function isLSPCheckRequired(): boolean {
  return true;
}

5. Funzione updateProtocolStatus

function updateProtocolStatus(lspClean: boolean): void {
  const status = {
    lastLSPCheck: new Date().toISOString(),
    lspClean,
    protocolApplied: lspClean
  };

  fs.writeFileSync(PROTOCOL_STATUS_FILE, JSON.stringify(status, null, 2));

  if (lspClean && fs.existsSync(LSP_CHECK_REQUIRED_FILE)) {
    fs.unlinkSync(LSP_CHECK_REQUIRED_FILE);
  }
}


6   Blocco da eseguire prima di creare l‚Äôapp Express

(incollare vicino all‚Äôinizio del file, prima di const app = express() o equivalente)

console.log('üöÄ AVVIO SERVER CON PROTOCOLLO ANTI-REGRESSIONE INTEGRATO');

if (process.env.NODE_ENV !== 'production') {
  const lspClean = checkLSPErrors();

  if (!lspClean) {
    console.error('üõë AVVIO BLOCCATO - Applicare protocollo anti-regressione prima di continuare');
    process.exit(1);
  }

  updateProtocolStatus(true);
  console.log('üéØ PROTOCOLLO SUPERATO - Avvio server autorizzato\n');
} else {
  console.log('‚úÖ PRODUZIONE: Protocollo LSP skippato - Bundle gi√† verificato\n');
}


7. Handler process.on('exit', ...)

(incollare pi√π in basso, dopo la configurazione iniziale, ma prima dell‚Äôavvio del server; posizione non critica)

Blocco da eseguire prima di creare l‚Äôapp Express
(incollare vicino all‚Äôinizio del file, prima di const app = express() o equivalente)
